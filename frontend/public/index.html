<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Geoportal</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    #map {
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([52.23, 21.01], 7);

  // PODKŁAD
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  // WMS
  const wmsLayer = L.tileLayer.wms('/geoserver/wms', {
    layers: 'geo:miasta',
    format: 'image/png',
    transparent: true,
    version: '1.3.1'
  }).addTo(map);

  // POPUP PO KLIKNIĘCIU
  map.on('hover', function (e) {
    const point = map.latLngToContainerPoint(e.latlng, map.getZoom());
    const size = map.getSize();

    const params = {
      request: 'GetFeatureInfo',
      service: 'WMS',
      srs: 'EPSG:4326',
      styles: '',
      transparent: true,
      version: '1.1.1',
      format: 'image/png',
      bbox: map.getBounds().toBBoxString(),
      height: size.y,
      width: size.x,
      layers: 'geo:miasta',
      query_layers: 'geo:miasta',
      info_format: 'application/json',
      x: Math.floor(point.x),
      y: Math.floor(point.y)
    };

    const url = '/geoserver/wms?' + new URLSearchParams(params).toString();

    fetch(url)
      .then(res => res.json())
      .then(data => {
        if (!data.features || data.features.length === 0) {
          return;
        }

        const props = data.features[0].properties;

        const html = `
          <b>Miasto:</b> ${props.nazwa}<br/>
          <b>ID:</b> ${props.id}
        `;

        L.popup()
          .setLatLng(e.latlng)
          .setContent(html)
          .openOn(map);
      });
  });
  map.on("click", function (e) {
  const bbox = map.getBounds().toBBoxString();
  const size = map.getSize();

  const params = {
    request: "GetFeatureInfo",
    service: "WMS",
    srs: "EPSG:3857",
    styles: "",
    transparent: true,
    version: "1.3.0",
    format: "image/png",
    bbox: bbox,
    height: size.y,
    width: size.x,
    layers: "geo:miasta",
    query_layers: "geo:miasta",
    info_format: "application/json",
    crs: "EPSG:3857",
    i: Math.round(e.containerPoint.x),
    j: Math.round(e.containerPoint.y)
  };

  const url =
    "/geoserver/wms?" +
    Object.keys(params)
      .map(k => k + "=" + encodeURIComponent(params[k]))
      .join("&");

  fetch(url)
    .then(res => res.json())
    .then(data => {
      if (!data.features.length) return;

      const props = data.features[0].properties;

      L.popup()
        .setLatLng(e.latlng)
        .setContent(`<b>${props.nazwa}</b>`)
        .openOn(map);
    });
});
</script>

</body>
</html>
